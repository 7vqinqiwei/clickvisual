apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: mogo
data:
  prometheus.yml: |
    global:
      evaluation_interval: "15s"
    rule_files:
      - /etc/prometheus/rules.yml
    # 配置采集目标
    scrape_configs:
    - job_name: prometheus
      static_configs:
      - targets:
        # 采集自身
        - localhost:9090
    alerting:
      # 告警配置文件
      alertmanagers:
      # 修改：使用静态绑定
      - static_configs:
        # 修改：targets、指定地址与端口
        - targets: ["alertmanager:9093"]
    remote_read:
      - url: "http://127.0.0.1:9201/read"
        read_recent: true
    remote_write:
      - url: "http://127.0.0.1:9201/write"
  rules.yml: |
    groups:
    - name: test-rule
      rules:
      - alert: NodeMemoryUsage
        expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 > 20
        for: 2m
        labels:
          team: node
        annotations:
          summary: "{{$labels.instance}}: High Memory usage detected"
          description: "{{$labels.instance}}: Memory usage is above 20% (current value is: {{ $value }}"